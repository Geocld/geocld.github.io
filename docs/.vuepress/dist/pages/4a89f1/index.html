<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>低版本react-native bundle拆包---jsbundle的拆解实践(一) | lijiahao&#39;s blog</title>
    <meta name="generator" content="VuePress 1.5.2">
    <link rel="icon" href="/img/favicon.ico">
    <meta name="description" content="前端，移动端和杂七杂八的技术分享">
    <meta name="keywords" content="前端博客,个人技术博客,前端,前端开发,前端框架,web前端,前端面试题,技术文档,学习,面试,JavaScript,js,ES6,TypeScript,vue,python,css3,html5,Node,git,github,markdown">
    <meta name="baidu-site-verification" content="7F55weZDDc">
    <meta name="theme-color" content="#11a8cd">
    <link rel="preload" href="/assets/css/0.styles.37c655b2.css" as="style"><link rel="preload" href="/assets/js/app.a9bdc083.js" as="script"><link rel="preload" href="/assets/js/2.e5ef3fc2.js" as="script"><link rel="preload" href="/assets/js/36.04a82eac.js" as="script"><link rel="prefetch" href="/assets/js/10.8d5d773f.js"><link rel="prefetch" href="/assets/js/11.23d9ff22.js"><link rel="prefetch" href="/assets/js/12.e59f6391.js"><link rel="prefetch" href="/assets/js/13.3e7141e6.js"><link rel="prefetch" href="/assets/js/14.fe486314.js"><link rel="prefetch" href="/assets/js/15.dbb9d75f.js"><link rel="prefetch" href="/assets/js/16.5d434c0a.js"><link rel="prefetch" href="/assets/js/17.da2946ee.js"><link rel="prefetch" href="/assets/js/18.36e8b01d.js"><link rel="prefetch" href="/assets/js/19.9b3b9de6.js"><link rel="prefetch" href="/assets/js/20.193b4724.js"><link rel="prefetch" href="/assets/js/21.616e69cf.js"><link rel="prefetch" href="/assets/js/22.3437dd07.js"><link rel="prefetch" href="/assets/js/23.9800f0eb.js"><link rel="prefetch" href="/assets/js/24.e5a8a296.js"><link rel="prefetch" href="/assets/js/25.6d348e84.js"><link rel="prefetch" href="/assets/js/26.c37cea17.js"><link rel="prefetch" href="/assets/js/27.53a95692.js"><link rel="prefetch" href="/assets/js/28.15b0cfe6.js"><link rel="prefetch" href="/assets/js/29.862a718b.js"><link rel="prefetch" href="/assets/js/3.a285842d.js"><link rel="prefetch" href="/assets/js/30.b9a503f5.js"><link rel="prefetch" href="/assets/js/31.a206f84e.js"><link rel="prefetch" href="/assets/js/32.1a84dedf.js"><link rel="prefetch" href="/assets/js/33.f76a3db5.js"><link rel="prefetch" href="/assets/js/34.c37860e7.js"><link rel="prefetch" href="/assets/js/35.03d6ab39.js"><link rel="prefetch" href="/assets/js/37.6318c57b.js"><link rel="prefetch" href="/assets/js/38.2b9b710b.js"><link rel="prefetch" href="/assets/js/39.569b7614.js"><link rel="prefetch" href="/assets/js/4.b2670b76.js"><link rel="prefetch" href="/assets/js/40.4bc8a30b.js"><link rel="prefetch" href="/assets/js/41.9e28cdcc.js"><link rel="prefetch" href="/assets/js/42.6a82f95a.js"><link rel="prefetch" href="/assets/js/43.3f8a62bd.js"><link rel="prefetch" href="/assets/js/44.7fa8ad87.js"><link rel="prefetch" href="/assets/js/45.7353d595.js"><link rel="prefetch" href="/assets/js/46.5b899020.js"><link rel="prefetch" href="/assets/js/47.6d30e01d.js"><link rel="prefetch" href="/assets/js/48.80d902b8.js"><link rel="prefetch" href="/assets/js/49.798c144d.js"><link rel="prefetch" href="/assets/js/5.743f4f71.js"><link rel="prefetch" href="/assets/js/50.75da1fc9.js"><link rel="prefetch" href="/assets/js/6.cc8be4ba.js"><link rel="prefetch" href="/assets/js/7.4906c9c9.js"><link rel="prefetch" href="/assets/js/8.44bf5540.js"><link rel="prefetch" href="/assets/js/9.68f02dbc.js">
    <link rel="stylesheet" href="/assets/css/0.styles.37c655b2.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open no-sidebar have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">lijiahao's blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/Geocld" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar" style="display:none;"><!----> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/Geocld" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <!----> </aside> <div><main class="page"> <div class="theme-vdoing-wrapper bg-style-1"><div class="articleInfo-wrap" data-v-14888ed5><div class="articleInfo" data-v-14888ed5><ul class="breadcrumbs" data-v-14888ed5><li data-v-14888ed5><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-14888ed5></a></li> <li data-v-14888ed5><a href="/categories/?category=%E6%8A%80%E6%9C%AF" title="分类" data-v-14888ed5>技术</a></li> <!----></ul> <div class="info" data-v-14888ed5><div title="作者" class="author iconfont icon-touxiang" data-v-14888ed5><a href="https://github.com/geocld" target="_blank" title="作者" class="beLink" data-v-14888ed5>lijiahao</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-14888ed5><a href="javascript:;" data-v-14888ed5>2019-07-16</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABH1JREFUSA3tVl1oHFUUPmdmd2ltklqbpJDiNnXFmgbFktho7YMPNiJSSZM0+CAYSkUELVhM6YuwIPpgoOKDqOBDC0XE2CQoNtQXBUFTTcCi+Wlh1V2TQExsUzcltd3M9Tt3ZjZzZ2fT+OJTL8yeM+eee757fmeJbq//KQL8X3DUSFOcfr7cRsRtxNQMWueeVzOkaITIGqQHNg5y8+jNW9ldM7A6nTpAjuolUikAwq7CE3WcM2RRDz+XGVgN3FptU/aUSlvq9Pa3iZ1+sgAqJyyAFqkipd9dqiwHF3P65YycLWc/6sqGrvoEoIp6DOFaX5h6+dnfjkWprwqsPk0dUGq5vySwDImC10KxFHgGL1SWoc92O3eVht09qdXNH11I2SsTsJYqMWzihqGMi+A+Garf3BAuuLI5oGlULyNfyB/HYNujwktOfRrMr5t77NmevqaUopx0grnKAyvVpmwUDB4x6FPXuGvYLTDwWsejwgtgkYKPqRJg8SV6xaiZ3ZTppGneS4yfH5/66fZSDHv+QZci/+h5c5UHtpy67JUqGppM0sh0Nc1dW6/N1W5Yoqat8/TU/VnadmdeW2PLLSyh0cvxBs3KbqTmwYPpxN4do/mzE8nEpvX/UMu2Wbp74zUAK5q6WkHns7V0eWkdPbPzd3rxkTGybadYySumVzhcaJFbs5UrEkQ/+CK8gF5dnh/6ciIZ73gwQ927L1IitoxKLXYP3SjYdOrHHfTZhRRlFyrorafPk20B3HPD1y2G3qKZME5Jcf3t/HUC13/8tSd++vqFveMUTwAUxSUFI1QekR1+bIze3D9MF2aq6cPvG72CgnldWCFqyRw3lwH8ZMerjTD9ElRO7Gv44wNpC90aASqGfVlz/Rx17srQ57/UU26hkhQqUB7dBR71WmzQhHUnblGmVOEw0jhbV1n9OlXUDCIRGaNV5Jp43N516fN7JmnTHdfp7Hgy0luO4aMhtkLL8Bi3bUWYvzh5Mn1dTxrL6QmGuRhGL/TiTTxRoEdTszSaq9GR0NGA3KdkOz3hqSV3MIDhQ5IVX/Ivx3umBti2es2h4eZby7x8br1rkf7Mo90AqC8aQ3sJeNzqFRu+vSANAQe3PL7l0HGOAdwDCeZYvNKeoZp1Qfs6Aipndh86HmFRi0LAnEO47wsqM6cdfjh3jBPUzhZy7nvlUfFsamED1VQt6aISHVymXZ/B2aCtIG8AI8xfobj2d3en1wWVhOeHELKmLQ1s211s88comkv4UCwWyF787mJdYXtNfhKAXVqnKTq8QZvGAGGOfaTo5pGZ/PwbUCr5+DPr/1J92JNHr9aOl/F3iI5+O1nfybsGxoimvZ3ViWSluDITw3P37mypheDIPY0tw7+O/5ApbkYw+zpfaUVu32Pi98+defdUhEpZkRFq0aqyNh9FuL9hpYbEm6iwi0z2REd09ZmyENEbuhjDWzKvZXTqKYaBIr3tt5kuPtQBZFvEUwHt60vfCNu41XsksH9Ij1BMMz1Y0OOunHNShFIP5868g5zeXmuLwL9T4b6Q2+KejgAAAABJRU5ErkJggg==">
          低版本react-native bundle拆包---jsbundle的拆解实践(一)
        </h1> <div class="theme-vdoing-content content__default"><h2>背景介绍</h2>
公司部分业务APP以react-native作为技术栈，且当前有一个完整的APP，不同的团队负责不同的业务开发，工作成果以子工程的形式加入到现有APP中，随着业务开发的迭代加快以及更多新的业务线的加入，子工程体积增加，进而主工程的体积也跟着增加，同时热更新以全量包的形式进行，也大大增加了用户更新时的流量消耗，因此业务拆包势在必行，拆包的目标如下：
 <ol><li>减小业务打包生成的jsbundle体积，进而减小接入的APP的体积以及子工程热更新时下载体积，提升用户体验；</li> <li>实现基础jsbundle和业务jsbundle的分离，多个业务共用一个基础包，使业务jsbundle更纯粹，提高开发效率；</li> <li>优化子工程的jsbundle加载，实现基础包预加载，减小加载业务bundle时的白屏时间。</li></ol> <p>本系列文章将以react-native 0.55为具体例子，从以下几个方面讲述如何拆包以及如何使用拆出来的jsbundle进行异步加载:</p> <ol><li>0.52~0.55版本如何改造官方metro打包工具，使react-native bundle命令支持基础包和业务包的拆分；</li> <li>在原react-native应用的APP（之后称之为主工程）中，如何加入另一个react-native应用的子工程；</li> <li>主工程原生层如何预加载基础包，在进入对应的子工程viewController/Activity的时候加载业务包。</li></ol> <blockquote><p>注: 因为Facebook对react-native 0.56以上的metro拆包已经趋于完善并开放了<code>createModuleIdFactory</code>方法的接口，如果你的react-native版本在0.56以上，那么第一点你只需关注相关方法实现即可，第2、3点是基于APP原生的思路及实现，理论上在任意版本的react-native都适用。</p></blockquote> <p>本系列文章适合以下人群阅读：
熟悉react-native加载原理、打包流程，同时希望了解0.50以上RN异步加载jsbundle过程同时了解原生开发的开发人员。</p> <p>不适用以下人群：
react-native初学者，不了解APP原生开发及objective-c/Java语言的开发人员。</p> <h2>react-native jsbundle解析</h2>
在进行如何进行业务拆包之前，我们先对react-native的jsbundle做一个简单的认识。
<p>通过react-native bundle命令可对当前RN项目进行打包，以iOS为例，具体命令例子如下：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>react-native bundle --platform ios --dev false --entry-file index.js --bundle-output __test__/example/index.ios.jsbundle --assets-dest __test__/example/
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>在对应目录下即生成对应的<code>index.ios.jsbundle</code>和相应的assets文件夹，<code>index.ios.jsbundle</code>内容大致如下：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>var 
__DEV__ = false,
__BUNDLE_START_TIME__ = this.nativePerformanceNow ? nativePerformanceNow() : Date.now(),
process = this.process || {};
process.env=process.env || {};
process.env.NODE_ENV = &quot;production&quot;;
!(function(r) {
	&quot;use strict&quot;;
 
	r.__r = o, 
 
	r.__d = function(r,i,n) {
		if(null != e[i]) 
			return;
		e[i] = {
			dependencyMap:n,factory:r,hasError:!1,importedAll:t,importedDefault:t,isInitialized:!1,publicModule:{exports:{}}
		}
	},
 
	r.__c = n;
 
   ....
   
})();
__d(function(r,o,t,i,n){t.exports=r.ErrorUtils},18,[]);
...
...
__d(function(c,e,t,a,n){var r=e(n[0]);r(r.S,'Object',{create:e(n[1])})},506,[431,460]);
require(46);
require(11);
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p>可以看到jsbundle大致包含了4部分：</p> <ol><li>var 声明的变量，对当前运行环境的定义，bundle 的启动时间、Process进程环境相关信息;</li> <li>(function() { })() 闭包中定义的代码块，其中定义了对 define（__d）、  require（__r）、clear（__c） 的支持，以及 module（react-native及第三方dependences依赖的module） 的加载逻辑;</li> <li>__d 定义的代码块，包括RN框架源码 js 部分、自定义js代码部分、图片资源信息，供 require 引入使用;</li> <li>require定义的代码块，找到 <code>__d</code> 定义的代码块并执行，其中<code>require</code>中的数字即为 <code>__d</code>定义行中最后出现的那个数字。</li></ol> <p>可以看到，如果每个业务都单独打一个完整包，那么每个包都会包含第一部分和第二部分，因此我们的目标也就是把第一部分和第二部分提取出来，放到基础包<code>common.jsbundle</code>中，到时业务包共用此基础包。</p> <h2>业务拆包</h2>
业务拆包有两个方法：1.使用google的[diff-match-patch](https://github.com/google/diff-match-patch)工具计算业务patch，在集成到主工程并需要加载业务页面时，再合成一个完整的jsbundle进行加载；2.扩展react-native官方打包工具metro，将打包后的业务代码提取出来，下面一一介绍。
<h2 id="diff-match-patch拆包"><a href="#diff-match-patch拆包" class="header-anchor">#</a> diff-match-patch拆包</h2> <p>Google给<code>diff-match-patch</code>提供了多语言版本，包括Java、Objective-c、Python及JavaScript等，因此很很容易用在跨平台的react-native应用中。首先我们在没有业务代码的RN框架进行打包，得到<code>common.ios.jsbundle</code>，接下来再添加业务代码，如在一个业务页面添加代码<code>&lt;Text&gt;Hello World&lt;/Text&gt;</code>，打包，得到业务包<code>business.ios.bundle</code>，接下来我们写一段脚本，将我们添加的这段代码通过diff-match-patch提取出来，以补丁(patch)的形式作为业务拆包:</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// split.js</span>
<span class="token keyword">const</span> DiffMatchPatch <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'diff-match-patch'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
<span class="token keyword">const</span> dmp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DiffMatchPatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/common.ios.jsbundle</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">e<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> commonData <span class="token operator">=</span> data<span class="token punctuation">;</span>
  fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/business.ios.jsbundle</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">e<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> businessData <span class="token operator">=</span> data<span class="token punctuation">;</span>
    <span class="token keyword">const</span> patch <span class="token operator">=</span> dmp<span class="token punctuation">.</span><span class="token function">patch_make</span><span class="token punctuation">(</span>commonData<span class="token punctuation">,</span> businessData<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 生成补丁</span>
    <span class="token keyword">const</span> patchText <span class="token operator">=</span> dmp<span class="token punctuation">.</span><span class="token function">patch_toText</span><span class="token punctuation">(</span>patch<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 生成补丁文本</span>
     fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/diff.ios.patch</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> patchText<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>使用node执行此脚本，得到<code>diff.ios.patch</code>，内容如下：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>@@ -761599,32 +761599,83 @@
 ent(s.Text,null,
+%22Hello World%22),o.default.createElement(s.Text,null,
 this.state.param
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>可以看到，<code>diff-match-patch</code>生成的patch记录了业务包和公共包的差异部分，差异部分以特殊的符号记录了对应位置、字符等信息。</p> <p>业务包体积方面，原<code>business.ios.jsbundle</code>大小为1.2MB，经过<code>diff-match-patch</code>处理得到的<code>diff-mch_apply</code>仅为121B，在子应用整合到主应用时，业务只需提供一个<code>.patch</code>文件，主工程再根据需要使用<code>diff-match-patch</code>的<a href="https://github.com/google/diff-match-patch/wiki/API#patch_applypatches-text1--text2-results" target="_blank" rel="noopener noreferrer">patch_apply<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>方法将<code>diff.ios.jsbundle</code>和<code>common.ios.js</code>重新合成一个完整的<code>business.ios.jsbundle</code>即可。</p> <p>到了这里通过<code>diff-match-patch</code>拆业务包得到<code>xxx.patch</code>的方案看起来很完美，但是我们最后没有采取这个方案，因为<code>diff-match-patch</code>在实际的业务包处理过程中存在以下大坑:</p> <ol><li><code>diff-match-patch</code>得到的patch是记录业务包和基础包的差异，并且是文本记录，除了记录单纯的业务代码差异外，还加入了额外的补丁信息，实际业务开发过程中，差异部分是很多的，因此一个原1000行的业务jsbundle经过<code>diff-match-patch</code>处理，得到的<code>diff.patch</code>文件能达到2000多行！原业务包大小为3.6MB，补丁包大小居然达到7.2MB！这大大违背了我们拆包的初衷。</li> <li><code>diff-match-patch</code>的<code>patch_apply</code>方法在Android中存在严重的效率问题，性能一般的机型，光是合并刚才上面Hello world的例子拆出来的仅为121B的<code>diff.patch</code>，就花了3200ms左右！如果补丁文件再大一些，合并效率会更低，因此完整的业务拆包<code>diff-match-patch</code>并不适用。</li></ol> <h2 id="使用metro拆包"><a href="#使用metro拆包" class="header-anchor">#</a> 使用metro拆包</h2> <p>metro是react-native的官方打包工具及dev server工具，在执行<code>react-native bundle</code>或在RN项目下执行<code>npm start</code>时，实际是调用metro-builder来进行加载打包任务的，针对拆包工作，0.56之后版本的RN依赖的metro已经趋于完善，开放了<code>--config &lt;path / to / config&gt;</code>参数来配置提供自定义文件，通过这个配置选项，我们就可以通过两个关键方法配置来修改打包配置，这两个方法分别是:<code>createModuleIdFactory</code>，<code>processModuleFilter</code>。</p> <ul><li><code>createModuleIdFactory</code>负责固定 module 的ID。在上文的<code>jsbundle解析</code>中，<code>__d</code>中定义的各个module后都有一个数字表示，并在最后的require方法中进行调用（如require(41)），这其中的数字就是<code>createModuleIdFactory</code>方法生成的，如果添加了module，那么ID会重新生成，如果要做一个基础包，那么公共module的ID必须是固定的，因此0.56+版本的RN可以通过此方法的接口来将module的ID固定，0.52~0.55的RN依赖的metro也用到了这个方法，只是没暴露出来，因此可以通过修改源码的方式来实现0.56+版本相同的效果。</li> <li><code>processModuleFilter</code> 负责过滤掉基础包的内容模块，0.56以下版本没有此方法，因此需要我们自己来实现这个过滤方法。</li></ul> <p>##1. 固定模块ID
首先是固定module ID，我们来看metro <code>createModuleIdFactory</code>的实现，在<code>metro/src/lib/createModuleIdFactory.js</code>看到该方法， 很简单:</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">createModuleIdFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> fileToIdMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> nextId <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token parameter">path</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> id <span class="token operator">=</span> fileToIdMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> id <span class="token operator">!==</span> <span class="token string">'number'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        id <span class="token operator">=</span> nextId<span class="token operator">++</span><span class="token punctuation">;</span>
        fileToIdMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> id<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> createModuleIdFactory<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>从上述源码也可以看出，系统使用整数型的方式，从0开始遍历所有模块，并依次使 Id 增加 1。所以我们可以修改此处逻辑，以模块路径名称的方式作为Id即可。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">createModuleIdFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>__PROD__<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// debug模式</span>
    <span class="token keyword">const</span> fileToIdMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> nextId <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token parameter">path</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> id <span class="token operator">=</span> fileToIdMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> id <span class="token operator">!==</span> <span class="token string">'number'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        id <span class="token operator">=</span> nextId<span class="token operator">++</span><span class="token punctuation">;</span>
        fileToIdMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> id<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">// 生产打包使用具体包路径代替id，方便拆包处理</span>
    <span class="token comment">// 定义项目根目录路径</span>
    <span class="token keyword">const</span> projectRootPath <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    <span class="token comment">// path 为模块路径名称</span>
    <span class="token keyword">return</span> <span class="token parameter">path</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> moduleName <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'node_modules\\react-native\\Libraries\\'</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          moduleName <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">'\\'</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>projectRootPath<span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
          moduleName <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span>projectRootPath<span class="token punctuation">.</span>length <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
  
      moduleName <span class="token operator">=</span> moduleName<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">'.js'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      moduleName <span class="token operator">=</span> moduleName<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">'.png'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      moduleName <span class="token operator">=</span> moduleName<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">'.jpg'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      moduleName <span class="token operator">=</span> moduleName<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/\\/g</span><span class="token punctuation">,</span> <span class="token string">'_'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 适配Windows平台路径问题</span>
      moduleName <span class="token operator">=</span> moduleName<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/\//g</span><span class="token punctuation">,</span> <span class="token string">'_'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 适配macos平台路径问题</span>
  
      <span class="token keyword">return</span> moduleName<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> createModuleIdFactory<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><p>这里我加了一个<code>process.env.__PROD__</code>的判断，即在开发模式下依旧使用原模式（<strong>因为我发现全局改的话开发模式会运行失败</strong>）。在打包的时候注入一个<code>__PROD__</code>环境变量才会进入自定义固定ID那段方法，在这段代码中，依据模块路径 path，在其基础上进行自定义路径名称，并作为 Id 返回，使用模块的路径作为ID，保证返回的ID是绝对固定的。</p> <p>##2. 基础包和业务包打包
在完成了打包源码修改后，接下来就是要分别打出基础模块与业务模块的jsbundle文件。在打包之前，需要我们分别定义好基础模块与业务模块文件，核心代码如下：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// base.js</span>
<span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'react-native'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'react'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">...</span>这里可以引入更多的第三方模块及自己的公共模块
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// index.js</span>
<span class="token keyword">class</span> <span class="token class-name">App</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>
    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>
            <span class="token operator">&lt;</span>View<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>Text<span class="token operator">&gt;</span>
                    hello world
                <span class="token operator">&lt;</span><span class="token operator">/</span>Text<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>View<span class="token operator">&gt;</span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

AppRegistry<span class="token punctuation">.</span><span class="token function">registerComponent</span><span class="token punctuation">(</span><span class="token string">&quot;business&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> App<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><blockquote><p>注1：base.js为基础模块入口，index.js为业务业务模块入口</p> <p>注2：<strong>base.js没有<code>AppRegistry.registerComponent</code>入口，业务模块必须要有这个入口，这个一定要注意，这个是网上很多类似拆包文章没有说清楚的事！！！</strong></p></blockquote> <p>接下来就是通过<code>react-native bundle</code>命令来进行打包了，需要两个不同的命令，区别在于打包入口文件参数（--entry-file）不一样:</p> <p>基础包:</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>react-native bundle --platform ios --dev <span class="token boolean">false</span> --entry-file base.js --bundle-output __test__/example/common.ios.jsbundle --assets-dest __test__/ios/
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>业务包:</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>react-native bundle --platform ios --dev <span class="token boolean">false</span> --entry-file index.js --bundle-output __test__/example/business.ios.jsbundle --assets-dest __test__/ios/
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>打完包打开jsbundle看下<code>require</code>及<code>__d</code>对应的module ID，看下是不是都变成模块路径了，通过这个也可以直观明了的看到jsbundle每一行对应的模块。</p> <p>##3.求出差异包
我们已经通过 react-native bundle 将基础包（common.jsbundle）和业务包（business.jsbundle）生成，接下来就是要生成一个业务包独有的内容，及差异包（diff.jsbundle）。关于这个差异包，网上流传的方法最多的方法就是通过linux的<code>comm</code>命令，命令如下:</p> <div class="language-Bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">comm</span> -2 -3 ./__test__/ios/business.ios.jsbundle ./__test__/ios/common.ios.jsbundle <span class="token operator">&gt;</span> ./__test__/ios/diff.ios.jsbundle
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>选项-2表示不显示在第二个文件中出现的内容， -3表示不显示同时在两个文件中都出现的内容，通过这个组合就可以生成业务模块独有的代码。在实际实践中，我发现求出来的<code>diff.jsbundle</code>依旧比较大，观察<code>diff.jsbundle</code>中的内容，发现<code>diff.jsbundle</code>和<code>common.jsbundle</code>中依旧有相同的内容！通过查这个<code>comm</code>命令的使用方法得知，这个命令在对有序文本的过滤效果是比较好的，但是面对我们杂乱无章的jsbundle文本，过滤效果就会出现bug，因此comm命令并不能求解出最优<code>diff.jsbundle</code>。</p> <p>那么换个思路，<code>common.jsbundle</code>和<code>business.jsbundle</code>都是纯文本文件，我们已经把各个模块的ID固定，而且每个模块的定义(也就是jsbundle中的__d)都是作为文本的固定行排列，两者相同的行肯定是一模一样的，那么就很好办了，只要对<code>business.jsbundle</code>进行逐行扫描，判断每一行是否有在<code>common.jsbundle</code>出现过，如没有出现过，那么肯定就是业务独有的内容，再将这些差异逐行写入<code>diff.jsbundle</code>，这样既保证了内容的唯一性，也保证了模块定义的顺序，在后续的异步加载jsbundle时不至于出现业务模块定义错乱的问题！实现的node.js代码如下(ps: 编程语言和求差算法可以进行进一步优化):</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// diff.js: 找出common和business的不同行</span>

<span class="token keyword">var</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> readline <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'readline'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">readFileToArr</span><span class="token punctuation">(</span><span class="token parameter">fReadName<span class="token punctuation">,</span>callback</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">var</span> fRead <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createReadStream</span><span class="token punctuation">(</span>fReadName<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> objReadline <span class="token operator">=</span> readline<span class="token punctuation">.</span><span class="token function">createInterface</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      input<span class="token operator">:</span>fRead
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> arr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  objReadline<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'line'</span><span class="token punctuation">,</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">line</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      arr<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//console.log('line:'+ line);</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  objReadline<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'close'</span><span class="token punctuation">,</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token comment">// console.log(arr);</span>
      <span class="token function">callback</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> argvs <span class="token operator">=</span> process<span class="token punctuation">.</span>argv<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> commonFile <span class="token operator">=</span> argvs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// common.ios.jsbundle</span>
<span class="token keyword">var</span> businessFile <span class="token operator">=</span> argvs<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// business.ios.jsbundle</span>
<span class="token keyword">var</span> diffOut <span class="token operator">=</span> argvs<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// diff.ios.jsbundle</span>
<span class="token function">readFileToArr</span><span class="token punctuation">(</span>commonFile<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">c_data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> diff <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> commonArrs <span class="token operator">=</span> c_data<span class="token punctuation">;</span>
  <span class="token function">readFileToArr</span><span class="token punctuation">(</span>businessFile<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">b_data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> businessArrs <span class="token operator">=</span> b_data<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> businessArrs<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>commonArrs<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>businessArrs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// business中独有的行</span>
        diff<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>businessArrs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// console.log(diff.length);</span>
    <span class="token keyword">var</span> newContent <span class="token operator">=</span> diff<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span>diffOut<span class="token punctuation">,</span> newContent<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 生成diff.ios.jsbundle</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div><p>使用方法:</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>node ./__test__/diff.js ./__test__/ios/common.ios.jsbundle ./__test__/ios/business.ios.jsbundle ./__test__/ios/diff.ios.jsbundle
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>至此，我们的基础包<code>base.jsbundle</code>和业务包<code>diff.jsbundle</code>就已经完成了，只要交付给主工程应用，主工程预集成基础包<code>base.jsbundle</code>，并在启动时预加载基础包，在进入不同业务时按需加载<code>diff.jsbundle</code>，这个我在后续章节会有详细介绍。</p> <h2 id="小结"><a href="#小结" class="header-anchor">#</a> 小结</h2> <p>本章重点讲解了react-native jsbundle在<code>diff-match-patch</code>和<code>metro</code>的拆包实践，可以看出，针对0.56以下版本的RN，最优解依旧是修改metro源码，进行拆包，而且源码修改量也不大，清晰易懂，效果明显。对于<code>diff-match-patch</code>的拆包则不适于拆解完整的业务包，但在代码量改动极小的热更新方面，使用<code>diff-match-patch</code>来进行补丁更新，效果会很明显。</p></div></div> <div class="page-edit"><!----> <div class="tags"><a href="/tags/?tag=React-Native" title="标签">
      #React-Native
    </a></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2020/08/08, 16:08:00</span></div></div> <div class="page-nav-wapper"><!----> <!----></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/658815/"><div>react-native run-ios内部原理探索</div></a> <span>03-05</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/3ffe0e/"><div>Android电话监听功能开发及注意事项</div></a> <span>01-22</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/85ee6e/"><div>关于Rom Hacking你可以了解到的一些事</div></a> <span>01-16</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div> </main></div> <div class="footer"><div class="icons"><a href="mailto:lijiahao53@gmail.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/geocld" title="GitHub" target="_blank" class="iconfont icon-github"></a></div> 
  Theme by <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
     | Copyright © 2015-2020
    <span>lijiahao | <a href="https://github.com/xugaoyi/vuepress-theme-vdoing/blob/master/LICENSE" target="_blank">MIT License</a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.a9bdc083.js" defer></script><script src="/assets/js/2.e5ef3fc2.js" defer></script><script src="/assets/js/36.04a82eac.js" defer></script>
  </body>
</html>